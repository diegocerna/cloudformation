{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Description of the full stack, this template create every environment based in the assinged parameters",

  "Parameters" : {
    "VPCcidr" : {
      "Type" : "String"
    },
    "Environment" : {
      "Type" : "String"
    },
    "SubnetCidr" : {
      "Type" : "String"
    },
    "KeyName" : {
      "Type" : "String"
    },
    "InstancesType" : {
      "Type" : "String",
      "Default" : "m3.medium"
    }
  },

  "Mappings" : {
    "NATMap" : {
      "us-east-1"      : { "AMI" : "ami-ad227cc4" },
      "us-west-1"      : { "AMI" : "ami-d69aad93" },
      "us-west-2"      : { "AMI" : "ami-f032acc0" }
    },
    "InstancesAMIS" : {
      "us-east-1"      : { "AMI" : "ami-95ac89fc" },
      "us-west-1"      : { "AMI" : "ami-8ca89ec9" },
      "us-west-2"      : { "AMI" : "ami-86b328b6" }
    }
  },

  "Resources":{
    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : {"Ref" : "VPCcidr"},
        "Tags" : 
        [ 
          {
            "Key" : "Application", 
            "Value" : { "Ref" : "AWS::StackId"}
          },
          {
            "Key" : "Environment", 
            "Value" : {"Ref" : "Environment"}
          }
        ]
      }
    },

    "Subnet" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : {"Ref" : "SubnetCidr"},
        "Tags" : [ 
          {
            "Key" : "Application", 
            "Value" : { "Ref" : "AWS::StackId"} 
          },
          {
            "Key" : "Environment", 
            "Value" : {"Ref" : "Environment"}
          }
        ]
      }
    },

    "SecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription": "test NPI group",
        "SecurityGroupIngress" : [{
          "IpProtocol" : "tcp",
          "FromPort" : "22" ,
          "ToPort" : "22",
          "CidrIp" : "0.0.0.0/0"
          }],
        "VpcId" : {"Ref" : "VPC"}
      }
    },

    "Worker" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "InstancesAMIS", { "Ref" : "AWS::Region" }, "AMI" ]},
        "KeyName" : { "Ref" : "KeyName" },
        "InstanceType" : {"Ref" : "InstancesType"},
        "SecurityGroupIds" : [{"Ref" : "SecurityGroup"}],
        "SubnetId" : {"Ref" : "Subnet"},
        "Tags" : [ {"Key" : "Name", "Value" : {"Fn::Join" : [".", ["Worket", {"Ref" : "Environment"}]]} } ]
      }
    },

    "PublicApiNAT" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "NATMap", { "Ref" : "AWS::Region" }, "AMI" ]},
        "KeyName" : { "Ref" : "KeyName" },
        "InstanceType" : "t1.micro",
        "SecurityGroupIds" : [{"Ref" : "SecurityGroup"}],
        "SubnetId" : {"Ref" : "Subnet"},
        "Tags" : [ {"Key" : "Name", "Value" : {"Fn::Join" : [".", ["PublicApiNAT", {"Ref" : "Environment"}]]} } ]
      }
    },

    "Redis" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "InstancesAMIS", { "Ref" : "AWS::Region" }, "AMI" ]},
        "KeyName" : { "Ref" : "KeyName" },
        "InstanceType" : {"Ref" : "InstancesType"},
        "SecurityGroupIds" : [{"Ref" : "SecurityGroup"}],
        "SubnetId" : {"Ref" : "Subnet"},
        "Tags" : [ {"Key" : "Name", "Value" : {"Fn::Join" : [".", ["Redis", {"Ref" : "Environment"}]]} } ]
      }
    },

    "OAuth" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "InstancesAMIS", { "Ref" : "AWS::Region" }, "AMI" ]},
        "KeyName" : { "Ref" : "KeyName" },
        "InstanceType" : {"Ref" : "InstancesType"},
        "SecurityGroupIds" : [{"Ref" : "SecurityGroup"}],
        "SubnetId" : {"Ref" : "Subnet"},
        "Tags" : [ {"Key" : "Name", "Value" : {"Fn::Join" : [".", ["OAuth", {"Ref" : "Environment"}]]} } ]
      }
    },

    "HelloWorld" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "InstancesAMIS", { "Ref" : "AWS::Region" }, "AMI" ]},
        "KeyName" : { "Ref" : "KeyName" },
        "InstanceType" : {"Ref" : "InstancesType"},
        "SecurityGroupIds" : [{"Ref" : "SecurityGroup"}],
        "SubnetId" : {"Ref" : "Subnet"},
        "Tags" : [ {"Key" : "Name", "Value" : {"Fn::Join" : [".", ["HelloWorld", {"Ref" : "Environment"}]]} } ]
      }
    },

    "Monitors" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "InstancesAMIS", { "Ref" : "AWS::Region" }, "AMI" ]},
        "KeyName" : { "Ref" : "KeyName" },
        "InstanceType" : {"Ref" : "InstancesType"},
        "SecurityGroupIds" : [{"Ref" : "SecurityGroup"}],
        "SubnetId" : {"Ref" : "Subnet"},
        "Tags" : [ {"Key" : "Name", "Value" : {"Fn::Join" : [".", ["Monitor", {"Ref" : "Environment"}]]} } ]
      }
    },

    "Accounts" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "InstancesAMIS", { "Ref" : "AWS::Region" }, "AMI" ]},
        "KeyName" : { "Ref" : "KeyName" },
        "InstanceType" : {"Ref" : "InstancesType"},
        "SecurityGroupIds" : [{"Ref" : "SecurityGroup"}],
        "SubnetId" : {"Ref" : "Subnet"},
        "Tags" : [ {"Key" : "Name", "Value" : {"Fn::Join" : [".", ["Accounts", {"Ref" : "Environment"}]]} } ]
      }
    },

    "API" : {
      "Type" : "AWS::EC2::Instance",

      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "InstancesAMIS", { "Ref" : "AWS::Region" }, "AMI" ]},
        "KeyName" : { "Ref" : "KeyName" },
        "InstanceType" : {"Ref" : "InstancesType"},
        "SecurityGroupIds" : [{"Ref" : "SecurityGroup"}],
        "SubnetId" : {"Ref" : "Subnet"},
        "Tags" : [ {"Key" : "Name", "Value" : {"Fn::Join" : [".", ["API", {"Ref" : "Environment"}]]} } ]
      }
    }

  }
}